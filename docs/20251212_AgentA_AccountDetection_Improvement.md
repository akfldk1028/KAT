# Agent A 계좌번호 탐지 개선 보고서

**작성일**: 2025-12-12
**버전**: sensitive_patterns.json v1.7.0

---

## 1. 문제 상황

### 기존 패턴의 한계

```regex
# 기존 계좌번호 정규식
\d{3}[\-ㅡ]\d{2,6}[\-ㅡ]\d{3,6}
```

**문제점:**
| 문제 | 설명 | 예시 |
|------|------|------|
| 하이픈 필수 | 하이픈 없는 계좌 미탐지 | `신한 110277121051` ❌ |
| 단일 형식 | 은행별 다양한 형식 미지원 | KB 14자리, 신한 12자리 등 |
| 평생계좌 미지원 | 010 형식 계좌 미탐지 | `기업 010-1234-5678` ❌ |
| 주민번호 오탐 | 13자리 숫자를 주민번호로 오인 | `3333011234567` → 주민번호 ❌ |

---

## 2. 해결 전략

### 2.1 접두사 기반 탐지

주요 은행의 계좌번호 접두사를 정의하여 하이픈 없이도 탐지:

| 은행 | 접두사 | 총 자릿수 |
|------|--------|-----------|
| 카카오뱅크 | 3333 | 13자리 |
| 토스뱅크 | 1000 | 12자리 |
| 케이뱅크 | 100, 777 | 12자리 |
| 신한은행 | 110, 140 | 12자리 |
| 우리은행 | 1002, 1005, 1006 | 13자리 |
| NH농협 | 301, 302, 312 | 13자리 |
| 단위농협 | 351, 352, 356 | 13-14자리 |
| 토스증권 | 2000 | 12자리 |
| 카카오증권 | 020 | 12자리 |

### 2.2 컨텍스트 기반 탐지

은행 키워드가 숫자 주변에 있으면 계좌번호로 판단:

```python
BANK_KEYWORDS = [
    "카카오뱅크", "토스뱅크", "케이뱅크", "KB국민", "신한", "우리", "하나",
    "IBK기업", "NH농협", "우체국", "새마을금고", "신협", "수협",
    "계좌", "통장", "입금", "송금", "이체", "예금주", ...
]
```

### 2.3 평생계좌 재분류

`010-xxxx-xxxx` 형식이 은행 키워드와 함께 있으면 전화번호가 아닌 계좌로 재분류:

```
"기업 010-1234-5678" → 계좌번호(평생계좌) ✓
"010-1234-5678"      → 전화번호 ✓
```

---

## 3. 수정 내역

### 3.1 sensitive_patterns.json

**변경 1: account_prefix 패턴 추가 (신규)**
```json
{
  "id": "account_prefix",
  "name_ko": "계좌번호(은행접두사)",
  "risk_level": "CRITICAL",
  "regex": "(?:3333\\d{9}|1000\\d{8}|(?:100|777)\\d{9}|...)"
}
```

**변경 2: resident_id 패턴 강화**
```json
{
  "id": "resident_id",
  "regex": "(?:[0-9][0-9](?:0[1-9]|1[0-2])(?:0[1-9]|[12][0-9]|3[01]))[\\-/][1-4]\\d{6}"
}
```
- 생년월일(YYMMDD) 유효성 검증 추가
- 하이픈/슬래시 필수로 변경
- 계좌번호 오탐 방지

### 3.2 pattern_matcher.py

**변경 1: 은행 키워드 목록 추가**
```python
BANK_KEYWORDS = [
    # 인터넷/시중은행 (20개)
    # 특수/상호금융 (10개)
    # 지방은행 (8개)
    # 증권사 (20개+)
    # 일반 키워드 (7개)
]
```

**변경 2: 컨텍스트 확인 함수**
```python
def _has_bank_context(text: str, match_start: int, window: int = 20) -> bool:
    """매칭된 숫자 주변에 은행 키워드가 있는지 확인"""
```

**변경 3: 컨텍스트 기반 계좌 탐지**
```python
def detect_context_accounts(text: str, existing_matches: List) -> List[Dict]:
    """은행 키워드 컨텍스트로 10-14자리 숫자를 계좌로 탐지"""
```

**변경 4: 평생계좌 재분류 로직**
```python
# 전화번호로 감지된 010 패턴 중 은행 컨텍스트가 있으면 계좌로 재분류
if item["id"] == "phone" and _has_bank_context(...):
    item["id"] = "account"
    item["name_ko"] = "계좌번호(평생계좌)"
```

**변경 5: 우선순위 조정**
```python
priority_order = {
    "resident_id": 1,      # 주민번호 (최우선)
    "card": 2,             # 신용카드
    "account_prefix": 3,   # 계좌번호(접두사) - 전화번호보다 높음!
    "phone": 5,            # 전화번호
    "account": 6,          # 계좌번호(하이픈 형식)
}
```

---

## 4. 테스트 결과

| # | 테스트 케이스 | 예상 결과 | 실제 결과 | 상태 |
|---|---------------|-----------|-----------|------|
| 1 | 신한 110277121051 | 계좌 | 계좌번호(은행접두사) | ✓ |
| 2 | 3333011234567 | 카카오 계좌 | 계좌번호(은행접두사) | ✓ |
| 3 | 1002-123-456789 | 우리 계좌 | 계좌번호 | ✓ |
| 4 | 기업 010-1234-5678 | 평생계좌 | 계좌번호(평생계좌) | ✓ |
| 5 | 010-1234-5678 | 전화번호 | 전화번호 | ✓ |
| 6 | 국민 12345612345678 | KB 계좌 | 계좌번호 | ✓ |
| 7 | 3010123456789 | NH농협 | 계좌번호(은행접두사) | ✓ |
| 8 | 100012345678 | 토스뱅크 | 계좌번호(은행접두사) | ✓ |
| 9 | 901231-1234567 | 주민번호 | 주민등록번호 | ✓ |
| 10 | 우리 10021234567890 | 우리 계좌 | 계좌번호(은행접두사) | ✓ |

**테스트 통과율: 10/10 (100%)**

---

## 5. 이번 세션 전체 작업 요약

### Frontend 수정
| 작업 | 파일 | 내용 |
|------|------|------|
| CSS 충돌 수정 | ChatBlock.tsx | `& img` → `& > img` |
| ImageViewerModal 통합 | ChatBlock.tsx | 이미지 클릭 시 모달 뷰어 |
| 시크릿 읽음 상태 | ChatBlock.tsx | 상대방 읽음 시 타임스탬프 표시 |
| 그냥보내기 버그 | ChattingRoomContainer.tsx | 메시지 전송 로직 누락 수정 |

### Backend/Agent 수정
| 작업 | 파일 | 내용 |
|------|------|------|
| 계좌 정규식 개선 | sensitive_patterns.json | 접두사 패턴 추가 |
| 주민번호 오탐 방지 | sensitive_patterns.json | 날짜 유효성 + 하이픈 필수 |
| 컨텍스트 탐지 | pattern_matcher.py | 은행 키워드 기반 탐지 |
| 평생계좌 지원 | pattern_matcher.py | 010+은행명 → 계좌 재분류 |
| 우선순위 조정 | pattern_matcher.py | account_prefix > phone |

---

## 6. 향후 개선 사항

1. **사업자등록번호 패턴 추가**: `xxx-xx-xxxxx` 형식 별도 처리
2. **더 많은 접두사 추가**: 저축은행, 새로운 핀테크 등
3. **OCR 이미지 테스트**: 신분증/통장 사진에서 계좌 탐지 검증
4. **성능 최적화**: 정규식 컴파일 캐싱

---

## 7. 참고 문서

- `은행계좌번호 탐지 프롬프트 및 특징.md`: 은행별 계좌 형식 상세 정보
- `agent/data/sensitive_patterns.json`: 민감정보 패턴 정의
- `agent/core/pattern_matcher.py`: 패턴 매칭 핵심 로직
